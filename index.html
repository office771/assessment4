<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>アセスメントツール</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        
        html, body, #root { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            font-family: 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .header-transition {
            transition: max-height 0.3s ease-in-out, opacity 0.3s;
            overflow: hidden;
        }

        /* PDF Styles */
        .pdf-container { width: 190mm; background: white; color: black; padding: 5mm 0; }
        .pdf-header { text-align: center; margin-bottom: 10px; }
        .pdf-title { font-size: 22px; font-weight: bold; border-bottom: 2px solid #333; padding-bottom: 5px; display: inline-block; width: 100%; }
        .pdf-meta { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 12px; }
        .pdf-category { margin-top: 0; }
        .pdf-cat-title { 
            background-color: #2b6cb0; 
            color: #fff; 
            padding: 5px 10px; 
            font-size: 15px; 
            border-radius: 4px; 
            font-weight: bold; 
            margin-bottom: 5px; 
        }
        .pdf-table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
        .pdf-table th, .pdf-table td { border: 1px solid #cbd5e0; padding: 5px; }
        .pdf-table th { background-color: #f7fafc; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const ASSESSMENT_DATA = [
            {
                category: "健康・生活",
                criteria: "【はい】いつも もしくは よく自分でできる、質問内容によく当てはまる。\n【いいえ】たまに もしくは ほとんど自分でできない、できる日もあればできない日もある。",
                items: [
                    { id: "h1", text: "十分な睡眠がとれて、規則正しい生活を送れている" },
                    { id: "h2", text: "体調を崩すことが少ない" },
                    { id: "h3", text: "過度に頑張り過ぎない" },
                    { id: "h4", text: "スプーンを鉛筆握りでこぼさずに食べる" },
                    { id: "h5", text: "丸のみせずによく噛んで食べられる" },
                    { id: "h6", text: "お箸を使って食べる(交差箸になっても良い)" },
                    { id: "h7", text: "食器を手にもって食べる" },
                    { id: "h8", text: "お箸を使用して食べこぼしせずに食べることができる" },
                    { id: "h9", text: "決められた時間内(給食時間等)にご飯を食べることができる" },
                    { id: "h10", text: "衣服の着脱が自分でできる(シャツやズボン両方できて「はい」)" },
                    { id: "h11", text: "ファスナーが付いた上着を着脱できる" },
                    { id: "h12", text: "服のボタンの付け外しができる(ボタンの大きさは問わない)" },
                    { id: "h13", text: "服が汚れると大人に知らせて着替える" },
                    { id: "h14", text: "服の前後を間違えずに着ることができる" },
                    { id: "h15", text: "服が汚れると自分で着替える" },
                    { id: "h16", text: "シャツの裾をズボンの中に入れることができる" },
                    { id: "h17", text: "大人の手助けがなくても自分で排泄ができる" },
                    { id: "h18", text: "排便後、お尻をトイレットペーパーで拭くことができる" },
                    { id: "h19", text: "外出先のトイレに行くことができる" },
                    { id: "h20", text: "お風呂で体を自分で洗うことができる(洗い残しはあっても良い)" },
                    { id: "h21", text: "自分で歯を磨くことができる" },
                    { id: "h22", text: "自分でお風呂に入り、髪や体を洗うことができる" },
                    { id: "h23", text: "寝癖を直すことができる" },
                    { id: "h24", text: "食後に口の周りや手をきれいにしている" },
                    { id: "h25", text: "歩道を歩く際に車に気を付ける" },
                    { id: "h26", text: "信号や横断歩道の交通ルールが守れる" },
                    { id: "h27", text: "学校へ自分で登校している" },
                    { id: "h28", text: "大人と一緒に慣れた場所へ交通機関を利用して行ける" },
                    { id: "h29", text: "大人の声かけで玩具を片付けることができる" },
                    { id: "h30", text: "自分が使ったものを元の場所に片付けることができる" },
                    { id: "h31", text: "忘れ物が少ない" },
                    { id: "h32", text: "物を紛失することが少ない" },
                    { id: "h33", text: "自分で学校の準備ができる" },
                    { id: "h34", text: "大人の声かけや誘導に合わせて次の行動に移れる" },
                    { id: "h35", text: "タイマーや視覚支援で次の行動へ移れる" },
                    { id: "h41", text: "硬貨や紙幣の種類や価値が分かる(例: 10円玉は50円玉より大きい)" },
                    { id: "h42", text: "自分で必要な金額を支払い、買い物することができる" }
                ]
            },
            {
                category: "感覚",
                criteria: "【はい】毎日見られる もしくは 月の半分以上見られる\n【いいえ】1度も見られない もしくは 月に数回程度見られる",
                items: [
                    { id: "s1", text: "活動や学習中に席を離れてしまう", type: "neg" },
                    { id: "s2", text: "部屋を理由もなく跳びはねることやくるくる回ることがある", type: "neg" },
                    { id: "s3", text: "椅子を後ろに傾けたり、揺らしたりして座る", type: "neg" },
                    { id: "s4", text: "体を揺らす、くるくる回ることがある", type: "neg" },
                    { id: "s5", text: "手をヒラヒラさせたりぐるぐる回るものを見つめる", type: "neg" },
                    { id: "s6", text: "物を置く位置や場所にこだわる", type: "neg" },
                    { id: "s7", text: "先生や友達にベタベタする", type: "neg" },
                    { id: "s8", text: "水や粘土、砂でよく遊ぶ" },
                    { id: "s9", text: "食べ物以外の固い物を口に入れて、噛んでいることがある", type: "neg" },
                    { id: "s10", text: "固くて弾力のある食べ物を好む", type: "neg" },
                    { id: "s11", text: "人や物のにおいを確かめることがある", type: "neg" },
                    { id: "s12", text: "名前を呼ばれても気づかないことがある", type: "neg" },
                    { id: "s13", text: "怪我に気づかないことがある", type: "neg" },
                    { id: "s14", text: "人に触れられても気づかないことがある", type: "neg" },
                    { id: "s15", text: "物を扱うときの力がつよい(例: ドアを勢いよく閉めるなど)", type: "neg" },
                    { id: "s16", text: "力加減が分からない", type: "neg" },
                    { id: "s17", text: "ブランコなどの揺れる、回転する遊具を好む", type: "neg" },
                    { id: "s18", text: "衣服が少しでも汚れることや濡れることを嫌がる", type: "neg" },
                    { id: "s19", text: "手が汚れることを嫌がる", type: "neg" },
                    { id: "s20", text: "洗髪や散髪、歯磨き、爪切り、耳かきを嫌がる(どれか1つでも該当していればはいを選択)", type: "neg" },
                    { id: "s21", text: "特定の素材や感触のある服を着たがらない", type: "neg" },
                    { id: "s22", text: "不安定な場所や高い場所を過度に怖がる", type: "neg" },
                    { id: "s23", text: "突然、押されたりすると怒る", type: "neg" },
                    { id: "s24", text: "特定の音や声を嫌がる", type: "neg" },
                    { id: "s25", text: "騒がしい場所を嫌がる", type: "neg" },
                    { id: "s26", text: "蛍光灯やLEDの光を嫌がる", type: "neg" },
                    { id: "s27", text: "突然、目を塞いだり目を細める", type: "neg" },
                    { id: "s28", text: "特定の嫌いなにおいがある", type: "neg" },
                    { id: "s29", text: "ご飯を食べる時に鼻をつまむ", type: "neg" },
                    { id: "s30", text: "食べ物の好き嫌いが多い(偏食がある)", type: "neg" }
                ]
            },
            {
                category: "運動",
                criteria: "【はい】質問内容によく当てはまる、よくできる(10回挑戦して7回以上成功する)、機会があればできると思われる\n【いいえ】質問内容にほとんど もしくは 全く当てはまらない、できない、できる時もあればできない時もある",
                items: [
                    { id: "m1", text: "姿勢を保つことができる" },
                    { id: "m2", text: "立っている時はまっすぐ姿勢を保てる" },
                    { id: "m3", text: "座っている時に姿勢が崩れることが少ない" },
                    { id: "m4", text: "平均台から落ちずに渡りきることができる" },
                    { id: "m5", text: "目を閉じて10秒以上片足立ちができる" },
                    { id: "m6", text: "だるまさんポーズが10秒以上できる（参考資料あり）" },
                    { id: "m7", text: "飛行機ポーズが10秒以上できる（参考資料あり）" },
                    { id: "m8", text: "10歩程度、手押し車で前へ進むことができる" },
                    { id: "m9", text: "寄り目ができる" },
                    { id: "m10", text: "バウンドする小さいボール(テニスボール等)をキャッチできる" },
                    { id: "m11", text: "約1m離れたところから投げられた小さなボールをキャッチできる" },
                    { id: "m12", text: "何もない所でつまずいて転ぶ", type: "neg" },
                    { id: "m13", text: "物によくぶつかる", type: "neg" },
                    { id: "m14", text: "ジャングルジムなどをくぐる際に頭や体をぶつける", type: "neg" },
                    { id: "m15", text: "バンザイのポーズを真似できる" },
                    { id: "m16", text: "指で四角を作るポーズを真似できる（参考資料あり）" },
                    { id: "m17", text: "右手で左耳を触るポーズを真似できる" },
                    { id: "m18", text: "危険なことや怪和等をせずに遊具で遊ぶことができる" },
                    { id: "m19", text: "同年齢児と比べて運動の苦手さや不器用さを感じない" },
                    { id: "m20", text: "ジャングルジムの頂上まで登ることができる" },
                    { id: "m21", text: "走り方にぎこちなさを感じない" },
                    { id: "m22", text: "数メートル先の相手に向かって、小さなボール(テニスボール等)を上投げで投げることができる" }
                ]
            },
            {
                category: "手指",
                criteria: "【はい】質問内容によく当てはまる、よくできる(10回挑戦して7回以上成功する)\n【いいえ】できない、できる時もあればできない時もある、機会があってもできないと思われる",
                items: [
                    { id: "f1", text: "洗濯ばさみを親指と人差し指、中指の腹でつまむことができる" },
                    { id: "f2", text: "紙をちぎることができる" },
                    { id: "f3", text: "大豆サイズのものをつまむことができる" },
                    { id: "f4", text: "親指と他の指の指先のタッピングができる（参考資料あり）" },
                    { id: "f5", text: "紐を結ぶことができる(固結び)" },
                    { id: "f6", text: "立体の制作物を作ることができる" },
                    { id: "f7", text: "カッターや包丁などの刃物を注意して扱える" },
                    { id: "f8", text: "「始めて使う道具も、使い方を教えられると正しく使うことができる" },
                    { id: "f9", text: "同年齢児と同じように細かい作業ができる" },
                    { id: "f10", text: "時々の声掛けなどで集中して作業を続けられる" },
                    { id: "f11", text: "手本を示しながら繰り返し説明をすれば作業工程を理解できる" },
                    { id: "f12", text: "説明された通り、正確に制作物等を作り上げることができる" },
                    { id: "f13", text: "同年齢児と同じくらいの作業速度で制作物等を作ることができる" },
                    { id: "f14", text: "繰り返ししている作業や制作活動は上達する" },
                    { id: "f15", text: "作業や制作活動を進める中で、分からないことは大人へ質問する、もしくは自分でもう一度説明書やお手本を見て解決することができる" },
                    { id: "f16", text: "○、×、△の形を全部書き写すことができる" },
                    { id: "f17", text: "文字のなぞり書きができる" },
                    { id: "f18", text: "文字の視写ができる" },
                    { id: "f19", text: "鏡文字は見られない" },
                    { id: "f20", text: "形が整った文字を書くことができる" },
                    { id: "f21", text: "ノートのマスに合わせて文字を書くことができる" },
                    { id: "f22", text: "丁度良い筆圧で文字を書くことができる" }
                ]
            },
            {
                category: "言語コミュニケーション",
                criteria: "【はい】質問内容によく当てはまる、よくできる\n【いいえ】当てはまらない、できない、同年齢に比べて課題がある",
                items: [
                    { id: "l1", text: "名前を呼ばれると呼んだ人の方向を振りむく" },
                    { id: "l2", text: "大人と視線を合わせることができる" },
                    { id: "l3", text: "「大人が玩具などを指さす方向を見ることができる" },
                    { id: "l4", text: "指差しや身振りで自分の思いを伝える" },
                    { id: "l5", text: "大人の言葉を真似ようとする" },
                    { id: "l6", text: "具体物を示すと指示を理解できる(例: 帽子を見せると外へ行くことがわかる)" },
                    { id: "l7", text: "カード等の視覚提示があると指示を理解することができる" },
                    { id: "l8", text: "絵本を見て「○○はどれ?」 と聞かれると指差しや言葉で答える" },
                    { id: "l9", text: "「○○ちょうだい、おしまい」などの簡単なことばかけの理解ができる" },
                    { id: "l10", text: "「手を洗う/ご飯を食べる/お茶を飲む」などの日常的な簡単な指示を理解できる" },
                    { id: "l11", text: "疑問詞「何・どこ・誰」を使った質問に答えることができる" },
                    { id: "l12", text: "「赤い大きな車」や「長い青い棒」などの指示を理解できる" },
                    { id: "l13", text: "「あげるもらう」を正しく使用できる" },
                    { id: "l14", text: "「追いかける-追いかけられる」の理解ができる" },
                    { id: "l15", text: "4人程度の小集団場面での指示が理解できる" },
                    { id: "l16", text: "日常生活の中でよく使用する物の名前が10個分かる" },
                    { id: "l17", text: "言えることばが50語ある" },
                    { id: "l18", text: "4色(赤、青 黄、緑)の色の名前が分かる" },
                    { id: "l19", text: "「座るものは?/雨の日にさすものは?」の質問に両方答えられる(回答例:椅子、傘)" },
                    { id: "l20", text: "「スプーンはどんなもの?」の質問に答えることができる(回答例: ご飯を食べる道具)" },
                    { id: "l21", text: "「ゾウは大きい。アリは?」の質問に答えられる(回答例: 小さい)" },
                    { id: "l22", text: "「赤いものには何がありますか?」の質問に3つ答えることができる(回答例: りんご、いちご、トマト等)" },
                    { id: "l23", text: "「丸いものには何がありますか?」の質問に3つ答えることができる(回答例: ボール、すいか、月等)" },
                    { id: "l24", text: "「大きくて鼻が長い動物は?」の質問に答えられる(答え:ゾウ)" },
                    { id: "l25", text: "何かしらの手段 (クレーンなど)で要求を伝える" },
                    { id: "l26", text: "言葉や代替手段 (絵カードやコミュニケーション支援機器)を使って要求を伝える" },
                    { id: "l27", text: "一語文で話す" },
                    { id: "l28", text: "二語文で話す" },
                    { id: "l29", text: "三語文でを話す" },
                    { id: "l30", text: "多語文で話す(例: 昼休みに運動場で友達とドッジボールをしました)" },
                    { id: "l31", text: "出来事を部分的に伝えることができる" },
                    { id: "l32", text: "目の前の出来事について説明できる" },
                    { id: "l33", text: "出来事を順序立てで説明できる" },
                    { id: "l34", text: "大人が推測せずに明瞭な言葉で伝えることができる" },
                    { id: "l35", text: "シャボン玉を大小吹き分ける" },
                    { id: "l36", text: "発音を誤ることなく話すことができる" },
                    { id: "l37", text: "話をする時に、思い浮かべたものをスムーズにことばにすることができる" }
                ]
            },
            {
                category: "社会性",
                criteria: "【はい】いつも もしくは よく見られる、質問内容によく当てはまる。\n【いいえ】たまに もしくは ほとんど見られない、当てはまらない。",
                items: [
                    { id: "soc1", text: "大人と一緒に活動を楽しめる" },
                    { id: "soc2", text: "他児と一緒に楽しむ様子が見られる" },
                    { id: "soc3", text: "自分の傍にいる人の遊びをじっと見ている" },
                    { id: "soc4", text: "他児と同じような遊びをしている(他児との交流は見られない)" },
                    { id: "soc5", text: "他児と1つの玩具を一緒に使って遊ぶ" },
                    { id: "soc6", text: "お友達と玩具の貸し借りができる" },
                    { id: "soc7", text: "お友達とごっこ遊びの中で役割を演じる" },
                    { id: "soc8", text: "「大人からの働きかけがあると、集団のルールを守って活動に参加できる" },
                    { id: "soc9", text: "3~5人程度の小集団の活動や遊びに参加することができる" },
                    { id: "soc10", text: "お友達と一緒に制作物などを作り上げることができる" },
                    { id: "soc11", text: "「ダメ・いけません」と言われると行動を止められる" },
                    { id: "soc12", text: "自分で順番を待つことができる" },
                    { id: "soc13", text: "大人からの働きかけがあると、イライラや不安などの気持ちを抑えられる" },
                    { id: "soc14", text: "気持ちの切り替えに時間がかかる", type: "neg" },
                    { id: "soc15", text: "好きなことをしている時に次の行動に移れない", type: "neg" },
                    { id: "soc16", text: "融通が利かない", type: "neg" },
                    { id: "soc17", text: "暴言や蹴る、叩くなどの行動が多い", type: "neg" },
                    { id: "soc18", text: "自分の思い通りにならないと怒ることがある", type: "neg" },
                    { id: "soc19", text: "自分が興味のあることを一方的に話してしまう", type: "neg" },
                    { id: "soc20", text: "お友達とのトラブル直後は反省するが、また同じことを繰り返してしまう", type: "neg" },
                    { id: "soc21", text: "お友達が嫌がることを繰り返ししてしまう", type: "neg" },
                    { id: "soc22", text: "相手と適切な距離を保てない", type: "neg" }
                ]
            }
        ];

        const App = () => {
            const [answers, setAnswers] = useState({});
            const [extraTexts, setExtraTexts] = useState({});
            const [itemNotes, setItemNotes] = useState({});
            const [childName, setChildName] = useState("");
            const [assessmentDate, setAssessmentDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeTab, setActiveTab] = useState(0);
            const [exporting, setExporting] = useState(false);
            const [isMenuOpen, setIsMenuOpen] = useState(true);
            const [validationErrors, setValidationErrors] = useState(null);
            const fileInputRef = useRef(null);
            const pdfContentRef = useRef(null);

            const requiredCount = useMemo(() => ASSESSMENT_DATA.reduce((acc, cat) => acc + cat.items.filter(i => !i.isExtra).length, 0), []);
            const answeredCount = Object.keys(answers).length;
            const progress = (answeredCount / requiredCount) * 100;

            const checkValidation = () => {
                const errors = [];
                ASSESSMENT_DATA.forEach((cat, idx) => {
                    const missingInCat = cat.items
                        .filter(item => !item.isExtra)
                        .filter(item => !answers[item.id]);
                    if (missingInCat.length > 0) {
                        errors.push({ idx, category: cat.category, count: missingInCat.length });
                    }
                });
                return errors;
            };

            const exportToPDF = async () => {
                if (!childName.trim()) {
                    setValidationErrors([{ category: "基本情報", count: "氏名が未入力です" }]);
                    return;
                }
                const errors = checkValidation();
                if (errors.length > 0) {
                    setValidationErrors(errors);
                    return;
                }

                setValidationErrors(null);
                setExporting(true);
                
                const element = pdfContentRef.current;
                const opt = {
                    margin: [20, 10, 20, 10],
                    filename: `アセスメントシート_${childName || '記録'}_${assessmentDate}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['css', 'legacy'] }
                };

                const dataStr = JSON.stringify({ childName, assessmentDate, answers, extraTexts, itemNotes });
                const payload = btoa(unescape(encodeURIComponent(dataStr)));

                try {
                    await html2pdf().set(opt).from(element).toPdf().get('pdf').then(pdf => {
                        pdf.setProperties({ keywords: `assessment-payload:${payload}` });
                    }).save();
                } catch (e) {
                    console.error(e);
                } finally {
                    setExporting(false);
                }
            };

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const content = new TextDecoder().decode(new Uint8Array(ev.target.result));
                        const marker = "assessment-payload:";
                        const idx = content.indexOf(marker);
                        if (idx !== -1) {
                            const base64 = content.substring(idx + marker.length, content.indexOf(')', idx)).trim();
                            const data = JSON.parse(decodeURIComponent(escape(atob(base64))));
                            setChildName(data.childName || "");
                            setAssessmentDate(data.assessmentDate || "");
                            setAnswers(data.answers || {});
                            setExtraTexts(data.extraTexts || {});
                            setItemNotes(data.itemNotes || {});
                            setValidationErrors(null);
                        }
                    } catch (err) { console.error("Restore failed"); }
                };
                reader.readAsArrayBuffer(file);
            };

            const getMissingCount = (catIdx) => {
                return ASSESSMENT_DATA[catIdx].items
                    .filter(item => !item.isExtra)
                    .filter(item => !answers[item.id]).length;
            };

            return (
                <div className="flex flex-col h-screen w-full max-w-5xl mx-auto bg-white shadow-2xl overflow-hidden relative font-sans">
                    {/* バリデーションエラーモーダル */}
                    {validationErrors && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl border-4 border-rose-500">
                                <div className="flex items-center gap-3 text-rose-600 mb-4 font-bold">
                                    <h2 className="text-xl">未入力があります</h2>
                                </div>
                                <ul className="space-y-2 mb-6 max-h-60 overflow-y-auto pr-2">
                                    {validationErrors.map((err, i) => (
                                        <li key={i} className="flex justify-between items-center text-sm font-bold p-2 bg-rose-50 rounded-lg text-rose-700">
                                            <span>{err.category}</span>
                                            <span className="bg-rose-200 px-2 py-0.5 rounded-full text-xs">{err.count}件</span>
                                        </li>
                                    ))}
                                </ul>
                                <button onClick={() => setValidationErrors(null)} className="w-full py-3 bg-slate-900 text-white rounded-xl font-black hover:bg-slate-800 transition-colors">入力を続ける</button>
                            </div>
                        </div>
                    )}

                    <header className="bg-slate-900 px-4 py-3 text-white shrink-0 flex items-center justify-between border-b border-slate-800">
                        <div className="flex flex-col flex-1">
                            <h1 className="text-sm font-black tracking-tight flex items-center gap-2">
                                <span className="bg-blue-600 px-1.5 py-0.5 rounded text-[10px]">AS</span>
                                {childName || "未入力"} - アセスメント
                            </h1>
                            <div className="flex items-center gap-2 mt-1">
                                <div className="w-full max-w-[150px] bg-slate-700 h-1.5 rounded-full overflow-hidden">
                                    <div className="bg-blue-400 h-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
                                </div>
                                <span className="text-[10px] text-slate-400 font-bold whitespace-nowrap">{answeredCount}/{requiredCount} 完了</span>
                            </div>
                        </div>
                        <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="ml-4 p-2 rounded-lg bg-slate-800 text-slate-400">▼</button>
                    </header>

                    <div className={`header-transition bg-slate-50 border-b ${isMenuOpen ? 'max-h-[600px] p-4' : 'max-h-0 py-0 opacity-0'}`}>
                        {/* プライバシー案内（追加部分） */}
                        <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-xl flex gap-3 items-start shadow-sm">
                            <div className="bg-blue-600 text-white rounded-full w-5 h-5 flex items-center justify-center shrink-0 text-[10px] font-bold mt-0.5">i</div>
                            <p className="text-[11px] text-blue-800 font-bold leading-relaxed">
                                本ツールで入力されたデータは、すべてお客様のブラウザ内でのみ処理されます。サーバーへの送信や保存は一切行われません。
                            </p>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 items-end">
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 block mb-1 uppercase tracking-widest">対象者名</label>
                                <input type="text" className="w-full p-2 border-2 border-slate-200 rounded-lg outline-none focus:border-blue-500 font-bold text-xs" placeholder="氏名を入力" value={childName} onChange={e => setChildName(e.target.value)} />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 block mb-1 uppercase tracking-widest">評価実施日</label>
                                <input type="date" className="w-full p-2 border-2 border-slate-200 rounded-lg outline-none focus:border-blue-500 font-bold text-xs" value={assessmentDate} onChange={e => setAssessmentDate(e.target.value)} />
                            </div>
                            <div className="flex gap-2 sm:col-span-2">
                                <button onClick={() => fileInputRef.current.click()} className="flex-1 px-4 py-2 bg-white border-2 border-slate-200 rounded-lg hover:bg-slate-100 font-bold text-[10px] transition-all">復元読込</button>
                                <input type="file" hidden ref={fileInputRef} accept=".pdf" onChange={handleFile} />
                                <button onClick={exportToPDF} disabled={exporting} className={`flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-[10px] shadow-lg transition-all ${exporting ? 'opacity-50' : ''}`}>{exporting ? '生成中...' : 'PDF保存'}</button>
                            </div>
                        </div>
                    </div>

                    <nav className="flex bg-slate-100 border-b overflow-x-auto scrollbar-hide shrink-0">
                        {ASSESSMENT_DATA.map((cat, i) => {
                            const missing = getMissingCount(i);
                            return (
                                <button key={i} onClick={() => setActiveTab(i)} className={`px-4 py-3 text-[10px] font-black transition-all border-b-2 shrink-0 relative ${activeTab === i ? "border-blue-600 text-blue-700 bg-white" : "border-transparent text-slate-400"}`}>
                                    {cat.category}
                                    {missing > 0 && <span className="absolute top-1 right-1 h-2 w-2 rounded-full bg-rose-500"></span>}
                                </button>
                            );
                        })}
                    </nav>

                    <div className="flex-1 overflow-y-auto bg-white relative">
                        <div className="px-4 py-3 bg-blue-50 border-b border-blue-100 sticky top-0 z-10 shadow-sm">
                            <p className="text-[10px] font-black text-blue-700 uppercase mb-0.5">判断基準</p>
                            <p className="text-xs text-blue-600 font-bold leading-relaxed whitespace-pre-wrap">{ASSESSMENT_DATA[activeTab].criteria}</p>
                        </div>

                        <div className="divide-y divide-slate-100">
                            {ASSESSMENT_DATA[activeTab].items.map((item, i) => (
                                <div key={item.id} className="p-4 flex flex-col md:flex-row md:items-start gap-4 hover:bg-blue-50/10 transition-all">
                                    <div className="flex items-center gap-3 shrink-0">
                                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center font-black text-xs border-2 ${answers[item.id] ? 'bg-green-100 border-green-500 text-green-700' : 'bg-slate-100 border-slate-200 text-slate-400'}`}>{i + 1}</div>
                                    </div>
                                    <div className="flex-1 flex flex-col">
                                        <div className="text-sm font-bold text-slate-700 leading-snug">
                                            <div className={!answers[item.id] ? "text-slate-800" : "text-slate-500"}>
                                                {item.text}
                                                {item.type === 'neg' && <span className="ml-2 px-1 py-0.5 bg-rose-50 text-rose-500 text-[8px] font-black rounded border border-rose-100">要観察</span>}
                                            </div>
                                        </div>
                                        <div className="mt-2">
                                            <input type="text" placeholder="メモ・状況を記入（任意）" className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-[10px] text-slate-600 focus:bg-white focus:border-blue-300 outline-none transition-all font-normal" value={itemNotes[item.id] || ""} onChange={(e) => setItemNotes({...itemNotes, [item.id]: e.target.value})} />
                                        </div>
                                    </div>
                                    <div className="flex gap-2 shrink-0 justify-end md:self-center">
                                        <button onClick={() => setAnswers({...answers, [item.id]: 'yes'})} className={`w-16 py-2 rounded-xl text-xs font-black border-2 transition-all ${answers[item.id] === 'yes' ? 'bg-green-500 border-green-500 text-white shadow-md' : 'bg-white border-slate-200 text-slate-400 hover:border-slate-300'}`}>はい</button>
                                        <button onClick={() => setAnswers({...answers, [item.id]: 'no'})} className={`w-16 py-2 rounded-xl text-xs font-black border-2 transition-all ${answers[item.id] === 'no' ? 'bg-rose-500 border-rose-500 text-white shadow-md' : 'bg-white border-slate-200 text-slate-400 hover:border-slate-300'}`}>いいえ</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="h-48 w-full shrink-0"></div>
                    </div>

                    <footer className="px-4 py-2 bg-slate-900 text-slate-500 text-[8px] font-bold shrink-0 text-center uppercase tracking-widest flex flex-col gap-1">
                        <div className="flex justify-center items-center gap-4">
                            <span>© ASSESSMENT TOOL v2.1</span>
                        </div>
                        {/* プライバシー案内（フッター追加部分） */}
                        <div className="normal-case opacity-40 leading-relaxed max-w-2xl mx-auto font-medium">
                            本ツールで入力されたデータは、すべてお客様のブラウザ内でのみ処理されます。サーバーへの送信や保存は一切行われません。
                        </div>
                    </footer>

                    {/* PDF用隠しレイアウト */}
                    <div style={{ position: "absolute", left: "-9999px" }}>
                        <div ref={pdfContentRef} className="pdf-container">
                            <div className="pdf-header">
                                <div className="pdf-title">アセスメントシート (評価記録)</div>
                            </div>
                            <div className="pdf-meta">
                                <span>氏名: <strong style={{fontSize: '14px'}}>{childName}</strong> 様</span>
                                <span>実施日: <strong>{assessmentDate}</strong></span>
                            </div>

                            {ASSESSMENT_DATA.map((cat, i) => (
                                <div key={i} className="pdf-category" style={{ pageBreakBefore: i === 0 ? 'avoid' : 'always', marginTop: i === 0 ? '0' : '0' }}>
                                    <div className="pdf-cat-title">{cat.category}</div>
                                    <div style={{ fontSize: '9px', marginBottom: '8px', fontStyle: 'italic', color: '#4a5568', whiteSpace: 'pre-wrap' }}>
                                        判断基準: {cat.criteria}
                                    </div>
                                    <table className="pdf-table">
                                        <thead>
                                            <tr>
                                                <th style={{ width: '75%', textAlign: 'left' }}>評価項目</th>
                                                <th style={{ width: '12.5%', textAlign: 'center' }}>はい</th>
                                                <th style={{ width: '12.5%', textAlign: 'center' }}>いいえ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {cat.items.map((item, j) => (
                                                <tr key={j} style={{ pageBreakInside: 'avoid' }}>
                                                    <td>
                                                        <div style={{ fontWeight: answers[item.id] ? 'bold' : 'normal' }}>
                                                            {item.text}
                                                        </div>
                                                        {itemNotes[item.id] && (
                                                            <div style={{ fontSize: '8px', color: '#718096', marginTop: '2px', paddingLeft: '6px', borderLeft: '1.5px solid #edf2f7' }}>
                                                                メモ: {itemNotes[item.id]}
                                                            </div>
                                                        )}
                                                        {item.type === 'neg' ? <span style={{fontSize:'8px', color: '#e53e3e'}}> (要観察項目)</span> : ''}
                                                    </td>
                                                    <td style={{ textAlign: 'center', fontWeight: 'bold' }}>
                                                        {answers[item.id] === 'yes' ? '●' : ''}
                                                    </td>
                                                    <td style={{ textAlign: 'center', fontWeight: 'bold' }}>
                                                        {answers[item.id] === 'no' ? '●' : ''}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
